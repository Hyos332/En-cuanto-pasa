name: CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18, 20]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
    
    - name: Install dependencies
      run: npm install
    
    - name: Run linter
      run: npm run lint
    
    - name: Run tests
      run: npm test
    
    - name: Build application
      run: npm run build

  deploy:
    needs: [test]
    if: github.ref == 'refs/heads/master'
    runs-on: self-hosted
    steps:
    - name: Deploy Application
      env:
        SLACK_SIGNING_SECRET: ${{ secrets.SLACK_SIGNING_SECRET }}
        SLACK_CLIENT_ID: ${{ secrets.SLACK_CLIENT_ID }}
        SLACK_CLIENT_SECRET: ${{ secrets.SLACK_CLIENT_SECRET }}
        SLACK_STATE_SECRET: ${{ secrets.SLACK_STATE_SECRET }}
      run: |
        cd /srv/projects/en-cuanto-pasa
        git fetch origin master
        git reset --hard origin/master
        echo "PORT=3005" > .env
        echo "SLACK_SIGNING_SECRET=$SLACK_SIGNING_SECRET" >> .env
        echo "SLACK_CLIENT_ID=$SLACK_CLIENT_ID" >> .env
        echo "SLACK_CLIENT_SECRET=$SLACK_CLIENT_SECRET" >> .env
        echo "SLACK_STATE_SECRET=$SLACK_STATE_SECRET" >> .env
        docker compose down
        docker rmi en-cuanto-pasa-slack-bot || true
        docker compose up -d --build --force-recreate